## Конвейер `math` (математические вычисления)

Конвейер `<q> | math ...` выполняет математические вычисления над **числовыми значениями** полей логов, возвращёнными запросом `<q>`. Он имеет следующий формат:

```
| math
  expr1 as resultName1,
  ...
  exprN as resultNameN
```

Где:
- `exprX` — одно из поддерживаемых математических выражений (см. ниже);
- `resultNameX` — имя поля, в которое будет сохранён результат вычисления.

Ключевое слово `as` **необязательно**. Если имя результата опущено, результат сохраняется в поле с именем, равным строковому представлению соответствующего математического выражения.

Выражение `exprX` может ссылаться на `resultNameY`, вычисленный **до** данного `exprX`.

**Пример**: следующий запрос делит значение поля `duration_msecs` на 1000, округляет результат до целого числа и сохраняет его в поле `duration_secs`:

```logsql
_time:5m | math round(duration_msecs / 1000) as duration_secs
```

### Поддерживаемые математические операции

- `arg1 + arg2` — возвращает сумму `arg1` и `arg2`;
- `arg1 - arg2` — возвращает разность `arg1` и `arg2`;
- `arg1 * arg2` — умножает `arg1` на `arg2`;
- `arg1 / arg2` — делит `arg1` на `arg2`;
- `arg1 % arg2` — возвращает остаток от деления `arg1` на `arg2`;
- `arg1 ^ arg2` — возводит `arg1` в степень `arg2`;
- `arg1 & arg2` — побитовое «И» для `arg1` и `arg2` (ожидается, что `arg1` и `arg2` находятся в диапазоне `[0 .. 2^53-1]`);
- `arg1 or arg2` — побитовое «ИЛИ» для `arg1` и `arg2` (диапазон тот же);
- `arg1 xor arg2` — побитовое «исключающее ИЛИ» для `arg1` и `arg2` (диапазон тот же);
- `arg1 default arg2` — возвращает `arg2`, если `arg1` не является числовым значением или равен `NaN`;
- `abs(arg)` — возвращает абсолютное значение `arg`;
- `ceil(arg)` — возвращает наименьшее целое число, **большее или равное** `arg`;
- `exp(arg)` — возводит число **`e`** в степень `arg`;
- `floor(arg)` — возвращает наибольшее целое число, **меньшее или равное** `arg`;
- `ln(arg)` — возвращает натуральный логарифм `arg`;
- `max(arg1, ..., argN)` — возвращает максимальное значение среди `arg1`, ..., `argN`;
- `min(arg1, ..., argN)` — возвращает минимальное значение среди `arg1`, ..., `argN`;
- `now()` — возвращает текущую **UNIX‑метку времени** в наносекундах;
- `rand()` — возвращает псевдослучайное число в диапазоне `[0...1)`;
- `round(arg)` — округляет `arg` до целого числа. Функция `round()` принимает необязательный аргумент `nearest`, позволяющий округлить число до заданного кратного.  
  **Пример**: `round(temperature, 0.1)` округляет значение поля `temperature` до одного знака после запятой.

### Что может содержать аргумент `argX`

Каждый аргумент `argX` в любой математической операции может быть:

1. **Именем поля лога**. Например, `errors_total / requests_total`.  
   - Поле лога преобразуется в числовое значение, если содержит поддерживаемое числовое значение.
   - Если поле содержит время в формате **RFC 3339**, оно преобразуется в UNIX‑метку времени в наносекундах.
   - Если поле содержит **IPv4‑адрес**, оно преобразуется в число `uint32`.
   - В остальных случаях поле преобразуется в `NaN`.

2. **Любым поддерживаемым числовым значением**, временем в формате RFC 3339 или IPv4‑адресом.  
   **Примеры**: `1MiB`, `"2024-05-15T10:20:30.934324Z"` или `"12.34.56.78"`.

3. **Другим математическим выражением**, заключённым в скобки `(...)`.  
   **Пример**: `(a + b) * c`.

### Преобразование результатов обратно в строку

Преобразованное время, длительность или IPv4‑адрес можно вернуть в строковое представление с помощью конвейера **`format`**.

**Пример**: следующий запрос округляет поле `request_duration` до секунд, а затем преобразует его обратно в строковое представление:

```logsql
_time:5m | math round(request_duration, 1e9) as request_duration_nsecs | format '<duration:request_duration_nsecs>' as request_duration
```

### Ключевое слово `eval`

Для удобства вместо `math` можно использовать ключевое слово `eval`.

**Пример**: следующий запрос вычисляет поле `duration_msecs`, умножая поле `duration_secs` на `1000`:

```logsql
_time:5m | eval (duration_secs * 1000) as duration_msecs
```
