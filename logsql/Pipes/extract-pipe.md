## Оператор `extract` (извлечение данных)

Оператор `extract` служит для **извлечения текста из указанного поля** и сохранения его в новые выходные поля согласно заданному шаблону.

Синтаксис:
```
<q> | extract "шаблон" from имя_поля
```

Где:
- `<q>` — исходный запрос, возвращающий логи;
- `"шаблон"` — шаблон для поиска и извлечения данных;
- `имя_поля` — поле, из которого производится извлечение (например, `_msg`).

**Важные особенности:**
- Существующие поля логов **не изменяются** после применения `| extract ...`.
- Извлечённые данные можно дальше обрабатывать с помощью других операторов, например `stats` (статистика) или `sort` (сортировка).

### Пример использования

Запрос выбирает логи с словом `error` за последний день, извлекает IP‑адрес из поля `_msg` в новое поле `ip`, затем выводит топ‑10 IP с наибольшим числом записей:

```logsql
_time:1d error | extract "ip=<ip> " from _msg | top 10 (ip)
```

**Условие:** поле `_msg` должно содержать подстроку `ip=...` с пробелом в конце (например, `error ip=1.2.3.4 from user_id=42`). Если подстрока не найдена, поле `ip` будет пустым.

### Сокращённая запись

Если `extract` применяется к полю `_msg`, часть `from _msg` можно опустить:

```logsql
_time:1d error | extract "ip=<ip> " | top 10 (ip)
```

### Работа с кавычками в шаблоне

Если шаблон содержит двойные кавычки, их нужно:
- либо экранировать обратным слешем `\`;
- либо заключить шаблон в одинарные кавычки.

**Пример** (извлечение IP из JSON):
```logsql
_time:5m | extract '"ip":"<ip>"'
```

### Дополнительные параметры

1. **`keep_original_fields`**  
   Сохраняет исходные непустые значения полей, упомянутых в шаблоне, вместо перезаписи извлечёнными данными.

   **Пример:**
   ```logsql
   _time:5m | extract 'ip=<ip> ' keep_original_fields
   ```
   Извлечение произойдёт, только если поле `ip` отсутствует или пусто.

2. **`skip_empty_results`**  
   Предотвращает перезапись существующих значений полей пустыми значениями, если извлечение не удалось.

   **Пример:**
   ```logsql
   _time:5m | extract 'ip=<ip> ' from foo skip_empty_results
   ```
   Исходное значение поля `ip` сохранится, если в поле `foo` нет подходящего IP.

### Рекомендации по производительности

- Используйте **более конкретные фильтры** для уменьшения числа обрабатываемых записей перед `extract`.
- Смотрите раздел *Общие рекомендации по производительности* в документации.



## Формат шаблона для `extract`

Шаблон имеет вид:
```
текст1<поле1>текст2<поле2>...текстN<полеN>текстN+1
```

Где:
- `текст1`, ..., `текстN+1` — произвольный непустой текст, который ищется буквально;
- `<поле1>`, ..., `<полеN>` — плейсхолдеры для извлечения подстрок.

### Типы плейсхолдеров

- **Анонимные**: `<_>` — пропускают часть текста до следующего `текстX`;
- **Именованные**: `<имя_поля>` — сохраняют извлечённую подстроку в поле с указанным именем.

### Правила сопоставления

1. Поиск начинается с первого вхождения `текст1` в исходном тексте.
2. Если шаблон начинается с `<поле1>` (без `текст1`), сопоставление идёт с начала текста.
3. Сопоставление выполняется последовательно. Если `текстX` не найден, оставшиеся именованные плейсхолдеры получают пустые значения, и процесс завершается.
4. Успешное завершение — когда найден `текстN+1`.
5. Если шаблон заканчивается на `<полеN>` (без `текстN+1`), `<полеN>` захватывает оставшийся текст.

### Пример

**Исходный текст** в поле `_msg`:
```
1.2.3.4 GET /foo/bar?baz 404 "Mozilla  foo bar baz" some tail here
```

**Шаблон** для извлечения `ip`, `path` и `user_agent`:
```
<ip> <_> <path> <_> "<user_agent>"
```

**Результат:**
- `ip` = `1.2.3.4`;
- `path` = `/foo/bar?baz`;
- `user_agent` = `Mozilla  foo bar baz` (кавычки автоматически удаляются).

### Автоматическое удаление кавычек

VictoriaLogs автоматически **удаляет кавычки** из извлечённых строк, если первый символ в плейсхолдере — кавычка или обратный апостроф. Это полезно для JSON и других форматов.

**Пример** (извлечение JSON‑строки):
```
"message":<msg>
```

### Отключение автоматического удаления кавычек

Добавьте префикс `plain:` перед именем поля:
```
some json string array: [<plain:json_array>]
```

### Экранирование специальных символов

Для поиска символов вроде `<` используйте HTML‑экранирование:
```
<left> &lt; <right>
```
Это сопоставит текст `a < b`, сохранив `a` в `left` и `b` в `right`.



## Условное извлечение (`conditional extract`)

Чтобы применить `extract` только к определённым записям, добавьте фильтр `if (<фильтры>)` после `extract`.

**Пример** (извлекать `ip` только если его нет в записи):
```logsql
_time:5m | extract if (ip:"") "ip=<ip> "
```

**Альтернатива:** использовать `keep_original_fields` (см. выше).



## См. также

- Формат шаблона для `extract`;
- Условное извлечение;
- Оператор `extract_regexp` (извлечение по регулярным выражениям);
- Операторы `unpack_json`, `unpack_logfmt`, `split`, `math` и др.
